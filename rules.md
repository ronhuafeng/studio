### FMEA Agent 系统约束详细分解表 (含编码)

**规则 ID 格式**: `模块-方向-等级-序号`
*   **模块**: `00` (All), `01` (Requirements), `02` (DFMEA), `03` (PFMEA)
*   **方向**: `0` (请求), `1` (响应)
*   **等级**: `0` (Error), `1` (Warning), `2` (Suggestion)
*   **序号**: 从 `01` 开始，在每个模块内递增

---

| 规则 ID | 请求类别 | 方向 | 约束等级 | 主类别 | 单项约束 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **00-0-0-01** | All | 请求 | `Error` | `scope` 字段约束 | 所有 `/analysis/*` 请求都必须包含 `scope` 字段。 | 此规则确保后端能明确区分是“从零开始生成结构”还是“在用户修改的基础上进行深化分析”。 |
| **00-0-0-02** | All | 请求 | `Error` | `scope` 字段约束 | 当 `scope="full_doc"` 时，请求体中必须包含 `modifiedStructure` 对象。 | |
| **00-0-0-03** | All | 请求 | `Error` | 会话与文档上下文 | 所有请求都必须包含 `sessionId`。 | |
| **00-0-1-04** | All | 请求 | `Warning` | `scope` 字段约束 | 当 `scope="structure_only"` 时，`modifiedStructure` 对象应被忽略或不存在。 | 发送多余的数据是一种不良实践，但后端应能容错处理。 |
| **00-0-2-05** | All | 请求 | `Suggestion` | 分析焦点 (`nodes`) 约束 | 请求中可选的 `nodes` 字段（一个 `[{ "uuid": ... }]` 列表）用于指定分析焦点。 | 此功能为未来实现“右键点击节点进行局部增量生成”提供了基础。 |
| **00-0-2-06** | All | 请求 | `Suggestion` | 会话与文档上下文 | 可选的 `documentIds` 列表用于告知 Agent 需要参考的上下文文档。 | 这是一个可选功能，用于提供更多上下文。 |
| **00-1-0-07** | All | 响应 | `Error` | 结构稳定性约束 | 在 `scope="full_doc"` 的场景下，Agent 返回的 `nodes` 列表**绝不能**修改或删除任何从 `modifiedStructure` 中接收到的节点的 `uuid` 和 `parentId`。 | 这是保证用户编辑内容不被 AI 覆盖的核心规则，是系统数据一致性的基石。 |
| **00-1-0-08** | All | 响应 | `Error` | 结构稳定性约束 | Agent 只能在现有结构上添加新节点。 | |
| **00-1-0-09** | All | 响应 | `Error` | 输出完整性与限制 | Agent 的输出必须是一个结构完整的 JSON 对象。 | 格式错误将导致整个响应无法被平台解析。 |
| **00-1-1-10** | All | 响应 | `Warning` | 输出完整性与限制 | **(需求分析特定)** 响应中 `nodes` 数组的长度上限为 100。 | 超出限制可能导致前端性能问题或降低可用性，但不一定会使系统崩溃。 |
| **01-1-0-01** | Requirements | 响应 | `Error` | 根节点约束 | 需求树必须有且仅有一个根节点 (`parentId: -1`)。 | 树状结构依赖于唯一的根节点。 |
| **01-1-0-02** | Requirements | 响应 | `Error` | 根节点约束 | 该根节点的 `nodeType` 必须是 `requirement`。 | 定义了树的类型和目的。 |
| **01-1-0-03** | Requirements | 响应 | `Error` | 层级关系约束 | `cha` 节点不能有任何子节点。 | 特性是分析的叶子节点，其下不应再有分解。 |
| **01-1-1-04** | Requirements | 响应 | `Warning` | 根节点约束 | 根节点（总需求）下不应直接挂载 `func` 或 `cha` 节点。 | 违反了需求分解的最佳实践，应先有子需求。 |
| **01-1-1-05** | Requirements | 响应 | `Warning` | 层级关系约束 | `func` 节点下不应再有 `func` 子节点。 | `func` 下再挂 `func` 违反了功能分解的逻辑。 |
| **02-1-0-01** | DFMEA | 响应 | `Error` | 结构骨架约束 | 必须有且仅有一个 `system` 类型的根节点。 | 此规则严格对齐 AIAG-VDA FMEA 方法论中的“结构分析”步骤，确保了分析的规范性。 |
| **02-1-0-02** | DFMEA | 响应 | `Error` | 结构骨架约束 | `system` 根节点下有且仅有一个 `subsystem` 类型的直接子节点。 | |
| **02-1-0-03** | DFMEA | 响应 | `Error` | 结构骨架约束 | 所有在 `subsystem` 节点之下的结构性节点，其类型必须是 `component`。 | |
| **02-1-0-04** | DFMEA | 响应 | `Error` | 元素挂载与层级约束 | `func` (功能) 节点只能被挂载在 `system`、`subsystem` 或 `component` 节点下。 | 功能必须依附于一个结构实体。 |
| **02-1-0-05** | DFMEA | 响应 | `Error` | 元素挂载与层级约束 | `cha` (特性) 的父节点必须是 `func`。 | 特性是功能的量化描述，逻辑上不能脱离功能存在。 |
| **02-1-0-06** | DFMEA | 响应 | `Error` | 元素挂载与层级约束 | `failure` (失效) 的父节点必须是 `func` 或 `cha`。 | 失效必须是“某个功能/特性的失效”。 |
| **02-1-0-07** | DFMEA | 响应 | `Error` | 字段逻辑约束 | `detection` 字段仅在 `category` 为 `2` (日常探测控制) 时才有效且必需。 | 数据模型的内在逻辑，在其他 category 下此字段无意义。 |
| **02-1-0-08** | DFMEA | 响应 | `Error` | 网络 (Net) 约束 | `featureNet` 用于连接 `func` 类型的节点；`failureNet` 用于连接 `failure` 类型的节点。 | 连接错误的节点类型会使网络失去其业务含义。 |
| **02-1-0-09** | DFMEA | 响应 | `Error` | 接口 (Interface) 约束 | `interface` 只能在 `component` 类型的节点之间建立。 | 接口的定义是组件间的交互。 |
| **02-1-0-10** | DFMEA | 响应 | `Error` | 接口 (Interface) 约束 | `interface` 的 `structureId` 必须是 `startId` 和 `endId` 的共同父节点的 `uuid`。 | 这是定位和渲染接口的必要信息。 |
| **02-1-1-11** | DFMEA | 响应 | `Warning` | 元素挂载与层级约束 | 一个 `func` 节点不应同时直接拥有 `cha` 子节点和 `failure` 子节点。 | 这是一个重要的逻辑规则，确保分析链条的清晰性。 |
| **02-1-1-12** | DFMEA | 响应 | `Warning` | 网络 (Net) 约束 | 如果响应中存在 `failureNet`，那么 `featureNet` 也应一并返回，反之亦然。 | 缺少一个会导致分析不完整，但系统仍可处理单个网络。 |
| **02-1-1-13** | DFMEA | 响应 | `Warning` | 网络 (Net) 约束 | 网络中不应在两个拥有相同父节点的同级节点之间建立连接。 | 违反了 FMEA 中功能/失效链的跨层级传递原则。 |
| **03-1-0-01** | PFMEA | 响应 | `Error` | 结构骨架约束 | PFMEA 树必须有且仅有一个根节点，且其 `nodeType` 必须是 `item`。 | 定义了 PFMEA 树的结构和起点。 |
| **03-1-0-02** | PFMEA | 响应 | `Error` | 特性类型上下文依赖 | 若 `cha` 的父节点是 `item`，则 `cha.extra.type` 必须是 `product`。 | 这是 PFMEA 的核心逻辑，确保了产品/过程特性的正确归属。 |
| **03-1-0-03** | PFMEA | 响应 | `Error` | 特性类型上下文依赖 | 若 `cha` 的父节点是 `elem`，则 `cha.extra.type` 必须是 `process`。 | |
| **03-1-0-04** | PFMEA | 响应 | `Error` | 元素挂载与层级约束 | `func` 节点只能被挂载在 `item`, `step`, `step2`, 或 `elem` 节点下。 | 功能必须依附于一个过程结构实体。 |
| **03-1-0-05** | PFMEA | 响应 | `Error` | 字段逻辑约束 | `detection` 字段仅在 `category` 为 `2` (日常探测控制) 时才有效且必需。 | 数据模型的内在逻辑。 |
| **03-1-0-06** | PFMEA | 响应 | `Error` | 网络 (Net) 约束 | `featureNet` 用于连接结构性节点；`failureNet` 用于连接 `mode` 类型的节点。 | 连接错误的节点类型会使网络失去其业务含义。 |
| **03-1-1-07** | PFMEA | 响应 | `Warning` | 元素挂载与层级约束 | `cha` 的父节点应优先为 `func`，而非直接挂在结构节点下。 | 鼓励遵循 `结构 → 功能 → 特性` 的完整逻辑链。 |
| **03-1-1-08** | PFMEA | 响应 | `Warning` | 网络 (Net) 约束 | 如果响应中存在 `failureNet`，那么 `featureNet` 也应一并返回，反之亦然。 | 缺少一个会导致分析不完整。 |
| **03-1-2-09** | PFMEA | 响应 | `Suggestion` | 结构骨架约束 | 推荐的结构层级为 `item` → `step` → `step2` → `elem`。 | 这是最佳实践，但系统也应能处理简化的层级。 |
